set -euo pipefail

# Backup the current .replit file
cp .replit .replit.pre-magick

# Overwrite .replit to ensure it includes all desired packages (OVERWRITE)
apply_patch <<'EOF'
*** Begin Patch
*** Update File: .replit
@@
-modules = ["nodejs-20"]
+modules = ["nodejs-20"]

@@ [nix]
-packages = ["gh", "imagemagick"]
+packages = ["gh", "imagemagick", "mailutils", "graphicsmagick-imagemagick-compat"]
*** End Patch
EOF

# Trigger environment rebuild (will occur on next Run)
echo "Configuration updated. Press Run in Replit to rebuild the environment."

# Commit changes if using git
if [ -d .git ]; then
  git add .replit
  git commit -m "chore: install imagemagick, mailutils & graphicsmagick via Nix"
fi
