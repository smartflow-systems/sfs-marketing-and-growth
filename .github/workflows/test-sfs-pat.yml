name: Test SFS_PAT
on:
  workflow_dispatch:

permissions:
  contents: read
jobs:
  test-token:
    runs-on: ubuntu-latest
    steps:
      - name: Check if SFS_PAT exists
        run: |
          if [ -z "${{ secrets.SFS_PAT }}" ]; then
            echo "‚ùå SFS_PAT secret is NOT set"
            exit 1
          else
            echo "‚úÖ SFS_PAT secret exists"
            echo "Token length: ${#SFS_PAT}"
          fi
        env:
          SFS_PAT: ${{ secrets.SFS_PAT }}

      - name: Test GitHub API authentication
        env:
          SFS_PAT: ${{ secrets.SFS_PAT }}
        run: |
          # Test with token scheme
          response=$(curl -s -H "Authorization: token $SFS_PAT" https://api.github.com/user)
          login=$(echo "$response" | jq -r '.login // empty')

          if [ -n "$login" ]; then
            echo "‚úÖ Successfully authenticated as: $login"
          else
            echo "‚ö†Ô∏è Token scheme failed, trying Bearer..."
            response=$(curl -s -H "Authorization: Bearer $SFS_PAT" https://api.github.com/user)
            login=$(echo "$response" | jq -r '.login // empty')

            if [ -n "$login" ]; then
              echo "‚úÖ Successfully authenticated as: $login (using Bearer)"
            else
              echo "‚ùå Authentication failed with both schemes"
              echo "Response: $response"
              exit 1
            fi
          fi

      - name: Test git clone with token
        env:
          SFS_PAT: ${{ secrets.SFS_PAT }}
        run: |
          git clone https://x-access-token:${SFS_PAT}@github.com/smartflow-systems/sfs-marketing-and-growth.git test-clone
          if [ -d "test-clone/.git" ]; then
            echo "‚úÖ Successfully cloned repo using SFS_PAT"
            rm -rf test-clone
          else
            echo "‚ùå Failed to clone repo"
            exit 1
          fi

      - name: Summary
        run: |
          echo "üéâ All SFS_PAT tests passed!"
          echo "The token is properly configured and working."
